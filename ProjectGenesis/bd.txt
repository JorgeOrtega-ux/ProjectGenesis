-- Base de datos: project_genesis
-- (Según config.php)

-- --- Tabla de Usuarios ---
-- Esta tabla almacena la información principal del usuario.
DROP TABLE IF EXISTS users;

CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    username VARCHAR(255) NOT NULL UNIQUE,
    -- Almacena la contraseña hasheada (ej. PASSWORD_BCRYPT)
    password VARCHAR(255) NOT NULL,
    profile_image_url VARCHAR(255) NULL,
    -- El ENUM se basa en los roles de styles.css y auth_handler.php
    `role` ENUM('user', 'moderator', 'administrator', 'founder') NOT NULL DEFAULT 'user',
    
    -- --- ▼▼▼ NUEVA COLUMNA 2FA ▼▼▼ ---
    -- Columna para activar/desactivar 2FA (0 = off, 1 = on)
    is_2fa_enabled TINYINT(1) NOT NULL DEFAULT 0,
    -- --- ▲▲▲ FIN DE LA NUEVA COLUMNA ▲▲▲ ---

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);
-- --- Tabla de Códigos de Verificación ---
-- Almacena códigos temporales para registro, reseteo de contraseña, etc.
DROP TABLE IF EXISTS verification_codes;
CREATE TABLE verification_codes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    -- 'identifier' guarda el email (para registro/reset/2fa)
    identifier VARCHAR(255) NOT NULL, 
    
    -- 'code_type' define el propósito del código
    -- --- ▼▼▼ MODIFICACIÓN ENUM ▼▼▼ ---
    code_type ENUM('registration', 'password_reset', '2fa') NOT NULL,
    -- --- ▲▲▲ FIN DE LA MODIFICACIÓN ▲▲▲ ---

    code VARCHAR(255) NOT NULL,
    -- 'payload' guarda datos extra (ej. username, password_hash) como JSON
    payload TEXT, 
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    -- Índice para búsquedas rápidas de códigos
    INDEX idx_identifier_type (identifier, code_type)
);
-- --- ▼▼▼ NUEVA TABLA DE SEGURIDAD ▼▼▼ ---
-- Almacena intentos fallidos para rate limiting
DROP TABLE IF EXISTS security_logs;
CREATE TABLE security_logs (
  id INT NOT NULL AUTO_INCREMENT,
  user_identifier VARCHAR(255) NOT NULL,
  action_type ENUM('login_fail','reset_fail') NOT NULL,
  ip_address VARCHAR(45) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  -- Índices para consultar rápidamente los intentos fallidos
  INDEX idx_user_time (user_identifier, created_at),
  INDEX idx_ip_time (ip_address, created_at)
);
-- --- ▲▲▲ FIN DE LA NUEVA TABLA ▲▲▲ ---